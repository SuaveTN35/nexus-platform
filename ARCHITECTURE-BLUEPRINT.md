# NEXUS Platform - Architecture Blueprint

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                    NEXUS PLATFORM ARCHITECTURE BLUEPRINT                      ║
║                                                                               ║
║  Generated by: CATALYST-CRM Super Agent                                       ║
║  Classification: Top 5% Global CRM Intelligence                               ║
║  Date: 2026-01-05                                                             ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## Executive Summary

NEXUS Platform is an AI-native business intelligence platform designed to outperform GoHighLevel through superior architecture, predictive intelligence, and autonomous operations. This document provides the complete technical architecture for Phase 1 implementation and future phases.

---

## Table of Contents

1. [Current State Analysis](#1-current-state-analysis)
2. [Target Architecture](#2-target-architecture)
3. [Phase 1: Database & Authentication](#3-phase-1-database--authentication)
4. [Phase 2: Core CRM Features](#4-phase-2-core-crm-features)
5. [Phase 3: AI Integration](#5-phase-3-ai-integration)
6. [Security Architecture](#6-security-architecture)
7. [Integration Architecture](#7-integration-architecture)
8. [Implementation Roadmap](#8-implementation-roadmap)

---

## 1. Current State Analysis

### 1.1 Completed Components (Phase 0)

```
✅ FRONTEND (100%)
├── 13 Pages (Home, Dashboard, Contacts, Deals, Campaigns, Analytics, Settings, Auth, Errors)
├── 14 UI Components (Button, Card, Input, Select, Modal, Table, Toast, etc.)
├── 3 Layout Components (Header, Footer, Sidebar)
├── 3 Custom Hooks (useContacts, useDeals, useCampaigns)
├── 2 Context Providers (AppContext, ToastProvider)
└── Complete Type System (TypeScript)

✅ API STRUCTURE (70%)
├── Contacts CRUD (/api/contacts, /api/contacts/[id])
├── Deals CRUD (/api/deals, /api/deals/[id])
├── Campaigns CRUD (/api/campaigns, /api/campaigns/[id])
└── API Client Library (lib/api-client.ts)

⚠️ BACKEND (40%)
├── Mock Data Implementation (needs database)
├── No Authentication (needs JWT)
└── No Authorization (needs RBAC)

⚠️ DATABASE (15%)
├── Prisma Schema Defined
├── PostgreSQL Not Connected
└── Migrations Not Run
```

### 1.2 Gap Analysis

| Component | Current | Target | Gap |
|-----------|---------|--------|-----|
| Database | Mock arrays | PostgreSQL + Prisma | HIGH |
| Authentication | None | JWT + Sessions | CRITICAL |
| Authorization | None | RBAC | HIGH |
| Real-time | None | WebSockets/SSE | MEDIUM |
| File Storage | None | S3/Local | MEDIUM |
| Email Service | None | SendGrid/Resend | MEDIUM |
| AI Features | None | LLM Integration | FUTURE |

---

## 2. Target Architecture

### 2.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  Next.js 15 App Router │ React 19 │ TypeScript │ Tailwind CSS 4.0          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  Pages   │ │Components│ │  Hooks   │ │ Contexts │ │   UI     │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  Next.js Route Handlers │ Middleware │ JWT Validation                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │/api/auth │ │/api/     │ │/api/     │ │/api/     │ │/api/     │          │
│  │          │ │contacts  │ │deals     │ │campaigns │ │analytics │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            SERVICE LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │   Auth   │ │ Contact  │ │  Deal    │ │ Campaign │ │Analytics │          │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │ Service  │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DATA LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  Prisma ORM │ PostgreSQL │ Redis Cache (Future)                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Users │ Organizations │ Contacts │ Deals │ Campaigns │ Activities  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Directory Structure (Target)

```
nexus-platform/
├── app/                          # Next.js App Router
│   ├── (auth)/                   # Auth route group (public)
│   │   ├── login/
│   │   ├── register/
│   │   └── forgot-password/
│   ├── (dashboard)/              # Protected route group
│   │   ├── dashboard/
│   │   ├── contacts/
│   │   ├── deals/
│   │   ├── campaigns/
│   │   ├── analytics/
│   │   └── settings/
│   ├── api/                      # API routes
│   │   ├── auth/
│   │   │   ├── login/route.ts
│   │   │   ├── register/route.ts
│   │   │   ├── logout/route.ts
│   │   │   └── refresh/route.ts
│   │   ├── contacts/
│   │   ├── deals/
│   │   ├── campaigns/
│   │   └── users/
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                       # Reusable UI components
│   ├── layout/                   # Layout components
│   ├── forms/                    # Form components
│   └── features/                 # Feature-specific components
├── lib/
│   ├── auth/                     # Authentication utilities
│   │   ├── jwt.ts
│   │   ├── password.ts
│   │   ├── session.ts
│   │   └── middleware.ts
│   ├── db/                       # Database utilities
│   │   ├── client.ts             # Prisma client singleton
│   │   └── queries/              # Database query functions
│   ├── services/                 # Business logic services
│   │   ├── auth.service.ts
│   │   ├── contact.service.ts
│   │   ├── deal.service.ts
│   │   └── campaign.service.ts
│   ├── validations/              # Zod schemas
│   └── utils/                    # General utilities
├── prisma/
│   ├── schema.prisma
│   ├── migrations/
│   └── seed.ts
├── types/
│   ├── index.ts
│   ├── api.ts
│   └── database.ts
├── hooks/
├── contexts/
└── middleware.ts                 # Next.js middleware (auth)
```

---

## 3. Phase 1: Database & Authentication

### 3.1 Database Schema (Enhanced)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  avatar        String?
  emailVerified DateTime?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  memberships   OrganizationMember[]
  activities    Activity[]
  sessions      Session[]

  @@index([email])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([refreshToken])
  @@index([userId])
}

// ==================== MULTI-TENANCY ====================

model Organization {
  id        String             @id @default(uuid())
  name      String
  slug      String             @unique
  logo      String?
  plan      PlanType           @default(STARTER)
  status    OrganizationStatus @default(ACTIVE)
  settings  Json               @default("{}")
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Relations
  members   OrganizationMember[]
  contacts  Contact[]
  deals     Deal[]
  campaigns Campaign[]
  pipelines Pipeline[]
  activities Activity[]

  @@index([slug])
}

model OrganizationMember {
  id             String     @id @default(uuid())
  userId         String
  organizationId String
  role           MemberRole @default(MEMBER)
  invitedAt      DateTime   @default(now())
  joinedAt       DateTime?
  isActive       Boolean    @default(true)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  AGENCY
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  CANCELED
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ==================== CRM CORE ====================

model Contact {
  id             String   @id @default(uuid())
  organizationId String

  // Basic Info
  firstName      String
  lastName       String
  email          String?
  phone          String?
  company        String?
  jobTitle       String?

  // Categorization
  tags           String[] @default([])
  source         String?
  lifecycleStage String   @default("lead")

  // Custom Data
  customFields   Json     @default("{}")

  // Engagement
  leadScore      Int      @default(0)
  lastContactedAt DateTime?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deals          Deal[]
  activities     Activity[]

  @@index([organizationId])
  @@index([email])
  @@index([organizationId, lifecycleStage])
}

model Deal {
  id                String     @id @default(uuid())
  organizationId    String
  contactId         String
  pipelineId        String?

  // Deal Info
  name              String
  value             Decimal    @db.Decimal(12, 2)
  stage             String
  stageOrder        Int        @default(0)
  probability       Int        @default(0)

  // Status
  status            DealStatus @default(OPEN)
  lostReason        String?
  wonReason         String?

  // Dates
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  pipeline     Pipeline?    @relation(fields: [pipelineId], references: [id])
  activities   Activity[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([contactId])
}

enum DealStatus {
  OPEN
  WON
  LOST
}

model Pipeline {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  isDefault      Boolean  @default(false)
  stages         Json     // Array of {name, order, probability}
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deals        Deal[]

  @@index([organizationId])
}

model Campaign {
  id             String         @id @default(uuid())
  organizationId String

  // Campaign Info
  name           String
  type           CampaignType
  status         CampaignStatus @default(DRAFT)

  // Scheduling
  startDate      DateTime?
  endDate        DateTime?

  // Content & Settings
  settings       Json           @default("{}")
  content        Json           @default("{}")

  // Metrics
  sentCount      Int            @default(0)
  openCount      Int            @default(0)
  clickCount     Int            @default(0)

  // Timestamps
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, status])
}

enum CampaignType {
  EMAIL
  SMS
  MULTI_CHANNEL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
}

// ==================== ACTIVITY TRACKING ====================

model Activity {
  id             String       @id @default(uuid())
  organizationId String
  contactId      String?
  dealId         String?
  userId         String?

  // Activity Info
  type           ActivityType
  subject        String
  description    String?
  metadata       Json         @default("{}")

  // Timestamps
  scheduledAt    DateTime?
  completedAt    DateTime?
  createdAt      DateTime     @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  deal         Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([contactId])
  @@index([dealId])
  @@index([organizationId, type])
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
  DEAL_CREATED
  DEAL_STAGE_CHANGED
  DEAL_WON
  DEAL_LOST
}
```

### 3.2 Authentication Architecture

```typescript
// lib/auth/jwt.ts

import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET!;
const JWT_EXPIRES_IN = '15m';
const REFRESH_TOKEN_EXPIRES_IN = '7d';

export interface TokenPayload {
  userId: string;
  email: string;
  organizationId: string;
  role: string;
}

export function generateAccessToken(payload: TokenPayload): string {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });
}

export function generateRefreshToken(payload: TokenPayload): string {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: REFRESH_TOKEN_EXPIRES_IN });
}

export function verifyToken(token: string): TokenPayload {
  return jwt.verify(token, JWT_SECRET) as TokenPayload;
}
```

```typescript
// lib/auth/password.ts

import bcrypt from 'bcryptjs';

const SALT_ROUNDS = 12;

export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS);
}

export async function verifyPassword(
  password: string,
  hash: string
): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

```typescript
// middleware.ts (Next.js Middleware)

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { verifyToken } from '@/lib/auth/jwt';

const PUBLIC_PATHS = [
  '/',
  '/login',
  '/register',
  '/forgot-password',
  '/api/auth/login',
  '/api/auth/register',
  '/api/auth/refresh',
];

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Allow public paths
  if (PUBLIC_PATHS.some(path => pathname.startsWith(path))) {
    return NextResponse.next();
  }

  // Check for auth token
  const token = request.cookies.get('access_token')?.value;

  if (!token) {
    if (pathname.startsWith('/api/')) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    return NextResponse.redirect(new URL('/login', request.url));
  }

  try {
    const payload = verifyToken(token);

    // Add user info to request headers
    const requestHeaders = new Headers(request.headers);
    requestHeaders.set('x-user-id', payload.userId);
    requestHeaders.set('x-organization-id', payload.organizationId);
    requestHeaders.set('x-user-role', payload.role);

    return NextResponse.next({
      request: { headers: requestHeaders },
    });
  } catch (error) {
    if (pathname.startsWith('/api/')) {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }
    return NextResponse.redirect(new URL('/login', request.url));
  }
}

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/contacts/:path*',
    '/deals/:path*',
    '/campaigns/:path*',
    '/analytics/:path*',
    '/settings/:path*',
    '/api/:path*',
  ],
};
```

### 3.3 Auth API Routes

```typescript
// app/api/auth/register/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/db/client';
import { hashPassword } from '@/lib/auth/password';
import { generateAccessToken, generateRefreshToken } from '@/lib/auth/jwt';
import { z } from 'zod';

const registerSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  firstName: z.string().min(1),
  lastName: z.string().min(1),
  organizationName: z.string().min(1),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const data = registerSchema.parse(body);

    // Check if user exists
    const existingUser = await prisma.user.findUnique({
      where: { email: data.email },
    });

    if (existingUser) {
      return NextResponse.json(
        { error: 'Email already registered' },
        { status: 400 }
      );
    }

    // Hash password
    const passwordHash = await hashPassword(data.password);

    // Create user, organization, and membership in transaction
    const result = await prisma.$transaction(async (tx) => {
      // Create organization
      const organization = await tx.organization.create({
        data: {
          name: data.organizationName,
          slug: data.organizationName.toLowerCase().replace(/\s+/g, '-'),
        },
      });

      // Create user
      const user = await tx.user.create({
        data: {
          email: data.email,
          passwordHash,
          firstName: data.firstName,
          lastName: data.lastName,
        },
      });

      // Create membership (as owner)
      await tx.organizationMember.create({
        data: {
          userId: user.id,
          organizationId: organization.id,
          role: 'OWNER',
          joinedAt: new Date(),
        },
      });

      // Create default pipeline
      await tx.pipeline.create({
        data: {
          organizationId: organization.id,
          name: 'Sales Pipeline',
          isDefault: true,
          stages: [
            { name: 'Lead', order: 1, probability: 10 },
            { name: 'Qualified', order: 2, probability: 25 },
            { name: 'Proposal', order: 3, probability: 50 },
            { name: 'Negotiation', order: 4, probability: 75 },
            { name: 'Closed Won', order: 5, probability: 100 },
            { name: 'Closed Lost', order: 6, probability: 0 },
          ],
        },
      });

      return { user, organization };
    });

    // Generate tokens
    const tokenPayload = {
      userId: result.user.id,
      email: result.user.email,
      organizationId: result.organization.id,
      role: 'OWNER',
    };

    const accessToken = generateAccessToken(tokenPayload);
    const refreshToken = generateRefreshToken(tokenPayload);

    // Create session
    await prisma.session.create({
      data: {
        userId: result.user.id,
        token: accessToken,
        refreshToken,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days
      },
    });

    // Set cookies
    const response = NextResponse.json({
      data: {
        user: {
          id: result.user.id,
          email: result.user.email,
          firstName: result.user.firstName,
          lastName: result.user.lastName,
        },
        organization: {
          id: result.organization.id,
          name: result.organization.name,
        },
      },
      message: 'Registration successful',
    });

    response.cookies.set('access_token', accessToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 15 * 60, // 15 minutes
    });

    response.cookies.set('refresh_token', refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 7 * 24 * 60 * 60, // 7 days
    });

    return response;
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Validation failed', details: error.errors },
        { status: 400 }
      );
    }
    console.error('Registration error:', error);
    return NextResponse.json(
      { error: 'Registration failed' },
      { status: 500 }
    );
  }
}
```

### 3.4 Database Service Pattern

```typescript
// lib/services/contact.service.ts

import { prisma } from '@/lib/db/client';
import { Prisma, Contact } from '@prisma/client';

export interface ContactFilters {
  search?: string;
  tags?: string[];
  lifecycleStage?: string;
}

export interface PaginationOptions {
  page: number;
  pageSize: number;
}

export const contactService = {
  async findMany(
    organizationId: string,
    filters: ContactFilters = {},
    pagination: PaginationOptions = { page: 1, pageSize: 10 }
  ) {
    const where: Prisma.ContactWhereInput = {
      organizationId,
    };

    // Apply search filter
    if (filters.search) {
      where.OR = [
        { firstName: { contains: filters.search, mode: 'insensitive' } },
        { lastName: { contains: filters.search, mode: 'insensitive' } },
        { email: { contains: filters.search, mode: 'insensitive' } },
        { company: { contains: filters.search, mode: 'insensitive' } },
      ];
    }

    // Apply tag filter
    if (filters.tags?.length) {
      where.tags = { hasSome: filters.tags };
    }

    // Apply lifecycle stage filter
    if (filters.lifecycleStage) {
      where.lifecycleStage = filters.lifecycleStage;
    }

    const [contacts, total] = await Promise.all([
      prisma.contact.findMany({
        where,
        skip: (pagination.page - 1) * pagination.pageSize,
        take: pagination.pageSize,
        orderBy: { createdAt: 'desc' },
      }),
      prisma.contact.count({ where }),
    ]);

    return {
      data: contacts,
      pagination: {
        page: pagination.page,
        pageSize: pagination.pageSize,
        total,
        totalPages: Math.ceil(total / pagination.pageSize),
      },
    };
  },

  async findById(id: string, organizationId: string) {
    return prisma.contact.findFirst({
      where: { id, organizationId },
      include: {
        deals: true,
        activities: {
          orderBy: { createdAt: 'desc' },
          take: 10,
        },
      },
    });
  },

  async create(organizationId: string, data: Prisma.ContactCreateInput) {
    return prisma.contact.create({
      data: {
        ...data,
        organization: { connect: { id: organizationId } },
      },
    });
  },

  async update(id: string, organizationId: string, data: Prisma.ContactUpdateInput) {
    return prisma.contact.updateMany({
      where: { id, organizationId },
      data,
    });
  },

  async delete(id: string, organizationId: string) {
    return prisma.contact.deleteMany({
      where: { id, organizationId },
    });
  },
};
```

---

## 4. Phase 2: Core CRM Features

### 4.1 Pipeline Management

```typescript
// lib/services/pipeline.service.ts

export const pipelineService = {
  async getDefaultPipeline(organizationId: string) {
    return prisma.pipeline.findFirst({
      where: { organizationId, isDefault: true },
    });
  },

  async getDealsByStage(organizationId: string, pipelineId: string) {
    const pipeline = await prisma.pipeline.findUnique({
      where: { id: pipelineId },
    });

    if (!pipeline) throw new Error('Pipeline not found');

    const deals = await prisma.deal.findMany({
      where: { organizationId, pipelineId, status: 'OPEN' },
      include: { contact: true },
      orderBy: { stageOrder: 'asc' },
    });

    // Group by stage
    const stages = pipeline.stages as Array<{ name: string; order: number; probability: number }>;
    return stages.map(stage => ({
      ...stage,
      deals: deals.filter(d => d.stage === stage.name),
      totalValue: deals
        .filter(d => d.stage === stage.name)
        .reduce((sum, d) => sum + Number(d.value), 0),
    }));
  },

  async moveDealToStage(dealId: string, newStage: string, organizationId: string) {
    const deal = await prisma.deal.findFirst({
      where: { id: dealId, organizationId },
      include: { pipeline: true },
    });

    if (!deal || !deal.pipeline) throw new Error('Deal not found');

    const stages = deal.pipeline.stages as Array<{ name: string; order: number; probability: number }>;
    const stageConfig = stages.find(s => s.name === newStage);

    if (!stageConfig) throw new Error('Invalid stage');

    // Update deal
    const updatedDeal = await prisma.deal.update({
      where: { id: dealId },
      data: {
        stage: newStage,
        stageOrder: stageConfig.order,
        probability: stageConfig.probability,
        status: newStage === 'Closed Won' ? 'WON' : newStage === 'Closed Lost' ? 'LOST' : 'OPEN',
        actualCloseDate: ['Closed Won', 'Closed Lost'].includes(newStage) ? new Date() : null,
      },
    });

    // Log activity
    await prisma.activity.create({
      data: {
        organizationId,
        dealId,
        type: newStage === 'Closed Won' ? 'DEAL_WON' : newStage === 'Closed Lost' ? 'DEAL_LOST' : 'DEAL_STAGE_CHANGED',
        subject: `Deal moved to ${newStage}`,
        metadata: { previousStage: deal.stage, newStage },
      },
    });

    return updatedDeal;
  },
};
```

### 4.2 Activity Timeline

```typescript
// lib/services/activity.service.ts

export const activityService = {
  async getTimeline(
    organizationId: string,
    options: {
      contactId?: string;
      dealId?: string;
      types?: ActivityType[];
      limit?: number;
    } = {}
  ) {
    return prisma.activity.findMany({
      where: {
        organizationId,
        ...(options.contactId && { contactId: options.contactId }),
        ...(options.dealId && { dealId: options.dealId }),
        ...(options.types?.length && { type: { in: options.types } }),
      },
      include: {
        user: { select: { firstName: true, lastName: true } },
        contact: { select: { firstName: true, lastName: true } },
        deal: { select: { name: true } },
      },
      orderBy: { createdAt: 'desc' },
      take: options.limit || 50,
    });
  },

  async log(data: {
    organizationId: string;
    type: ActivityType;
    subject: string;
    description?: string;
    contactId?: string;
    dealId?: string;
    userId?: string;
    metadata?: Record<string, any>;
  }) {
    return prisma.activity.create({ data });
  },
};
```

---

## 5. Phase 3: AI Integration

### 5.1 AI Architecture (Future)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI INTELLIGENCE LAYER                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Lead Scoring │  │  Next Best   │  │   Churn      │  │   Email      │    │
│  │    Model     │  │   Action     │  │ Prediction   │  │ Composition  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│         │                 │                 │                 │             │
│         └─────────────────┴─────────────────┴─────────────────┘             │
│                                    │                                         │
│                           ┌────────┴────────┐                               │
│                           │  AI Orchestrator │                               │
│                           │  (Claude API)    │                               │
│                           └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 AI Features Roadmap

| Feature | Description | Priority |
|---------|-------------|----------|
| Lead Scoring | Predict conversion probability | HIGH |
| Next Best Action | Suggest optimal follow-up | HIGH |
| Email Composition | AI-assisted email writing | MEDIUM |
| Sentiment Analysis | Analyze communication tone | MEDIUM |
| Churn Prediction | Identify at-risk customers | MEDIUM |
| Property Matching | Match contacts to properties | HIGH (Real Estate) |

---

## 6. Security Architecture

### 6.1 Security Layers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SECURITY ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  LAYER 1: TRANSPORT                                                          │
│  ├── HTTPS/TLS 1.3                                                          │
│  └── HTTP Strict Transport Security (HSTS)                                  │
│                                                                              │
│  LAYER 2: AUTHENTICATION                                                     │
│  ├── JWT Access Tokens (15 min expiry)                                      │
│  ├── Refresh Token Rotation                                                 │
│  ├── Session Management                                                      │
│  └── bcrypt Password Hashing (12 rounds)                                    │
│                                                                              │
│  LAYER 3: AUTHORIZATION                                                      │
│  ├── Role-Based Access Control (RBAC)                                       │
│  ├── Organization-Level Isolation                                           │
│  └── Resource-Level Permissions                                              │
│                                                                              │
│  LAYER 4: DATA PROTECTION                                                    │
│  ├── Encryption at Rest (PostgreSQL)                                        │
│  ├── Input Validation (Zod)                                                 │
│  ├── SQL Injection Prevention (Prisma ORM)                                  │
│  └── XSS Prevention (React)                                                  │
│                                                                              │
│  LAYER 5: MONITORING                                                         │
│  ├── Audit Logging                                                          │
│  ├── Rate Limiting                                                          │
│  └── Anomaly Detection                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 RBAC Permission Matrix

| Resource | Owner | Admin | Member | Viewer |
|----------|-------|-------|--------|--------|
| Organization Settings | CRUD | RU | R | R |
| Team Members | CRUD | CRU | R | R |
| Contacts | CRUD | CRUD | CRUD | R |
| Deals | CRUD | CRUD | CRUD | R |
| Campaigns | CRUD | CRUD | CRU | R |
| Analytics | R | R | R | R |
| Billing | CRUD | R | - | - |

---

## 7. Integration Architecture

### 7.1 Integration Hub

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INTEGRATION ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                           ┌─────────────────┐                               │
│                           │  NEXUS PLATFORM │                               │
│                           └────────┬────────┘                               │
│                                    │                                         │
│                           ┌────────┴────────┐                               │
│                           │ Integration Hub  │                               │
│                           │   (Webhooks +    │                               │
│                           │    REST API)     │                               │
│                           └────────┬────────┘                               │
│                                    │                                         │
│    ┌───────────┬───────────┬──────┴──────┬───────────┬───────────┐         │
│    │           │           │             │           │           │          │
│    ▼           ▼           ▼             ▼           ▼           ▼          │
│ ┌─────┐   ┌─────┐   ┌──────────┐   ┌─────┐   ┌─────┐   ┌─────┐            │
│ │Email│   │ Cal │   │Telephony │   │ n8n │   │Stripe│   │ AI  │            │
│ │Gmail│   │Gcal │   │ Twilio   │   │     │   │      │   │Claude           │
│ │O365 │   │O365 │   │          │   │     │   │      │   │      │           │
│ └─────┘   └─────┘   └──────────┘   └─────┘   └─────┘   └─────┘            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Webhook System

```typescript
// lib/services/webhook.service.ts

export const WEBHOOK_EVENTS = {
  'contact.created': 'When a new contact is created',
  'contact.updated': 'When a contact is updated',
  'contact.deleted': 'When a contact is deleted',
  'deal.created': 'When a new deal is created',
  'deal.stage_changed': 'When a deal moves to a new stage',
  'deal.won': 'When a deal is marked as won',
  'deal.lost': 'When a deal is marked as lost',
  'campaign.started': 'When a campaign starts',
  'campaign.completed': 'When a campaign completes',
} as const;

export type WebhookEvent = keyof typeof WEBHOOK_EVENTS;

export async function emitWebhookEvent(
  organizationId: string,
  event: WebhookEvent,
  payload: Record<string, any>
) {
  // Get registered webhooks for this event
  const webhooks = await prisma.webhook.findMany({
    where: {
      organizationId,
      events: { has: event },
      isActive: true,
    },
  });

  // Send to each webhook endpoint
  await Promise.allSettled(
    webhooks.map(webhook =>
      fetch(webhook.url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Webhook-Secret': webhook.secret,
          'X-Event-Type': event,
        },
        body: JSON.stringify({
          event,
          timestamp: new Date().toISOString(),
          data: payload,
        }),
      })
    )
  );
}
```

---

## 8. Implementation Roadmap

### 8.1 Phase 1: Database & Authentication (Current)

```
Week 1-2: Database Setup
├── [ ] Install and configure PostgreSQL
├── [ ] Run Prisma migrations
├── [ ] Create database client singleton
├── [ ] Seed development data
└── [ ] Test database connectivity

Week 3-4: Authentication
├── [ ] Implement JWT utilities
├── [ ] Create auth API routes (login, register, logout, refresh)
├── [ ] Build Next.js middleware
├── [ ] Update login/register pages
├── [ ] Test auth flows

Week 5-6: Data Integration
├── [ ] Create service layer for all entities
├── [ ] Update API routes to use database
├── [ ] Remove all mock data
├── [ ] Implement organization isolation
└── [ ] End-to-end testing
```

### 8.2 Phase 2: Core CRM Features

```
Week 7-8: Pipeline & Deals
├── [ ] Pipeline management UI
├── [ ] Drag-and-drop stage movement
├── [ ] Deal analytics
└── [ ] Win/loss tracking

Week 9-10: Activity & Engagement
├── [ ] Activity timeline component
├── [ ] Activity logging
├── [ ] Task management
└── [ ] Email logging preparation

Week 11-12: Advanced Features
├── [ ] Custom fields system
├── [ ] Import/export functionality
├── [ ] Search improvements
└── [ ] Bulk operations
```

### 8.3 Phase 3: AI & Integrations

```
Week 13-14: AI Foundation
├── [ ] Claude API integration
├── [ ] Lead scoring model
├── [ ] AI-assisted email composition
└── [ ] Next best action suggestions

Week 15-16: External Integrations
├── [ ] Email provider integration (Gmail/Outlook)
├── [ ] Calendar integration
├── [ ] Webhook system
└── [ ] n8n connector
```

---

## Quick Start Commands

```bash
# 1. Set up database
createdb nexus_platform
cp .env.example .env  # Configure DATABASE_URL

# 2. Run migrations
npx prisma migrate dev --name init
npx prisma generate

# 3. Seed data (optional)
npx prisma db seed

# 4. Start development
npm run dev
```

---

**Document Version:** 1.0
**Generated By:** CATALYST-CRM Super Agent
**Date:** 2026-01-05
**Classification:** INTERNAL USE ONLY
